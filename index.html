<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMH Bus Registration 2025/2026</title>
<style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f4f4f9;
        color: #333;
        margin: 20px;
        line-height: 1.6;
    }
    .container {
        max-width: 800px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
        text-align: center;
        color: #4CAF50;
    }
    p.intro {
        text-align: left;
        font-size: 16px;
    }
    label {
        margin-top: 10px;
        display: block;
    }
    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-row label {
        flex: 1;
    }
    .form-row input[type="text"],
    .form-row input[type="number"],
    .form-row input[type="email"],
    .form-row input[type="tel"],
    .form-row select {
        flex: 2;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    select {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .child-form {
        margin-top: 20px;
        padding: 10px;
        border-top: 2px solid #ccc;
    }
    .child-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .child-form-header h3 {
        margin: 0;
        flex: 0 0 140px;
    }
    .child-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    .child-form-row > div {
        flex: 1;
        min-width: 180px;
    }
    .email-phone-row {
        display: flex;
        gap: 10px;
    }
    .email-phone-row > input {
        width: calc(50% - 10px);
    }
    .riding-times {
        display: none;
        margin-top: 10px;
    }
    .riding-times input[type="checkbox"] {
        margin-right: 5px;
    }
    .riding-times-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .riding-times-grid label {
        display: flex;
        align-items: center;
    }
    button {
        width: 100%;
        padding: 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
    }
    button:hover {
        background-color: #45a049;
    }
    #costEstimation {
        margin-top: 20px;
        text-align: right;
    }
    #totalCost {
        font-weight: bold;
        color: #4CAF50;
    }
    .other-school {
        display: none;
    }
</style>
</head>
<body>
<div class="container">
<h1>CMH Bus Registration 2025/2026</h1>
<p class="intro">
    Welcome to the CMH Bus Registration for the 2025/2026 school year!<br><br>
    <b>New Timings:</b> The morning bus will now leave from CMH at <b>7:50am</b> (instead of 8:00am). Please arrive between <b>7:40–7:45am</b>.
    The bus will drop off first at <b>TDSO around 8:20am</b> and then at <b>OJCS at 8:35am</b>.<br>
    In the afternoon, it will leave OJCS at <b>3:50pm</b>, pick up at TDSO at <b>4:05pm</b>, and return to CMH around <b>4:40pm</b>.<br><br>
    <b>Costs:</b> Fees have increased about 5%. The calculation is shown below.<br><br>
    <b>Payments:</b> All payments will be made via eTransfer to <b>cmhbus@gmail.com</b>.<br>
    - If paid <b>in full before September 1</b>, you'll receive a <b>2% discount</b>.<br>
    - If paid monthly, please send <b>10 payments</b> on the <b>1st day of each month</b> from September to June.<br><br>
    <b>Good news:</b> We expect to have enough seats for everyone — no more waitlist!
</p>
<hr>
<form id="registrationForm" action="https://script.google.com/macros/s/AKfycbxhAW94LXwNKOkWAJoZh5cdnF1FQpZpQQpzBcM7Umy5tnXdz0nloQbNCrjQFojNAu_76w/exec" method="POST">
<!-- <form id="registrationForm" action="https://formspree.io/f/xwpelrve" method="POST"> -->
    <div class="form-row">
        <label for="parentName">Your name:</label>
        <input type="text" id="parentName" name="parentName" required>
    </div>
    <label for="parentEmail1">Parent or guardian email addresses:</label>
    <div class="email-phone-row">
        <input type="email" id="parentEmail1" name="parentEmail1" placeholder="Email 1" required>
        <input type="email" id="parentEmail2" name="parentEmail2" placeholder="Email 2">
    </div>

    <label for="parentPhone1">Parent or guardian phone numbers:</label>
    <div class="email-phone-row">
        <input type="tel" id="parentPhone1" name="parentPhone1" placeholder="Phone number 1" required>
        <input type="tel" id="parentPhone2" name="parentPhone2" placeholder="Phone number 2">
    </div>

    <div class="form-row">
        <label for="numChildren">Number of children:</label>
        <input type="number" id="numChildren" name="numChildren" min="1" required style="width: 60px;">
        <div style="flex: 1;"></div>
    </div>

    <div id="childrenForms"></div>

    <div id="costEstimation">
        <p>Total Cost: $<span id="totalCost">700</span></p>
    </div>

    <hr>

    <label><input type="checkbox" name="agreeCodeOfConduct">I agree to the <a href="https://bit.ly/machzikei-bus-code-of-conduct" target="_blank">bus code of conduct</a> and will discuss it with my children</label>

    <div class="code-of-conduct-acknowledgement">
        <label><input type="checkbox" name="acknowledgeStaySeated"> <b>Stay seated:</b> I will remind my child to stay seated with their seatbelt fastened for the entire ride.</label>
        <label><input type="checkbox" name="acknowledgeLowVolume"> <b>Low volume:</b> I will remind my child to keep their voice and devices at a quiet level.</label>
        <label><input type="checkbox" name="acknowledgeBeRespectful"> <b>Be respectful:</b> I will remind my child to respect the driver, the supervisors, the teachers, and the other students at all times.</label>
    </div>
    <hr>

    <label for="paymentOptions">Payment Options:</label>
    <select id="paymentOptions" name="paymentOptions" required onchange="updateCost()">
        <option value="">-- Please select --</option>
        <option value="fullPayment">I'll eTransfer the full amount to cmhbus@gmail.com (one time payment)</option>
        <option value="monthlyInstallments">I'll set up monthly eTransfer payments to cmhbus@gmail.com. Payments will be on the 1st day of the month.</option>
        <option value="other">I'll pay by another means</option>
    </select><br>

    <div class="form-row">
        <label for="comments">Additional Comments:</label>
        <textarea id="comments" name="comments" rows="4" placeholder="Enter any additional comments or special instructions here." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
    </div>

    <input type="hidden" id="FTEHidden" name="FTE" value="0">
    <input type="hidden" id="totalCostHidden" name="totalCost" value="700">
    <button type="submit">Register</button>
</form>
</div>

<script>
document.getElementById('numChildren').addEventListener('input', updateChildrenForms);

function updateChildrenForms() {
    const numChildren = parseInt(document.getElementById('numChildren').value);
    const childrenFormsContainer = document.getElementById('childrenForms');
    childrenFormsContainer.innerHTML = '';

    if (isNaN(numChildren) || numChildren <= 0) {
        updateCost();
        return;
    }

    for (let i = 1; i <= numChildren; i++) {
        const childForm = document.createElement('div');
        childForm.classList.add('child-form');
        childForm.innerHTML = `
            <div class="child-form-header">
                <h3>Child ${i}</h3>
                <input type="text" id="child${i}Name" name="child${i}Name" placeholder="Child's name" required>
            </div>
            <div class="child-form-row">
                <div>
                    <label for="child${i}School">What school will the child attend?</label>
                    <select id="child${i}School" name="child${i}School" required>
                        <option value="">-- Please select --</option>
                        <option value="OJCS">OJCS</option>
                        <option value="TDSO">TDSO</option>
                        <option value="TorahHigh">Torah High</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="text" id="child${i}OtherSchool" name="child${i}OtherSchool" class="other-school" placeholder="Please specify school" style="display:none;">
                </div>

                <div id="child${i}GradeDiv" style="display:none;">
                    <label for="child${i}Grade">Grade:</label>
                    <select id="child${i}Grade" name="child${i}Grade" required></select>
                </div>

                <div id="child${i}CarseatDiv" style="display:none;">
                    <label for="child${i}Carseat">Will the child be in a carseat?</label>
                    <select id="child${i}Carseat" name="child${i}Carseat" required>
                        <option value="">-- Please select --</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div id="child${i}TimeTypeDiv" style="display:none;">
                    <label for="child${i}TimeType">Full time or part time:</label>
                    <select id="child${i}TimeType" name="child${i}TimeType" required>
                        <option value="">-- Please select --</option>
                        <option value="fullTime">Full time</option>
                        <option value="partTime">Part time</option>
                    </select>
                </div>
            </div>
            <div id="child${i}RidingTimes" class="riding-times" style="display:none;">
                <label>Riding times (select all that apply):</label>
                <div class="riding-times-grid">
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Monday AM" checked> Monday AM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Monday PM" checked> Monday PM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Tuesday AM" checked> Tuesday AM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Tuesday PM" checked> Tuesday PM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Wednesday AM" checked> Wednesday AM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Wednesday PM" checked> Wednesday PM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Thursday AM" checked> Thursday AM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Thursday PM" checked> Thursday PM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Friday AM" checked> Friday AM</label>
                    <label><input type="checkbox" name="child${i}RidingTimes[]" value="Friday PM" checked> Friday PM</label>
                </div>
            </div>
        `;
        childrenFormsContainer.appendChild(childForm);

        // Setup event listeners
        document.getElementById(`child${i}School`).addEventListener('change', () => handleSchoolChange(i));
    }
    updateCost();
}

function handleSchoolChange(childIndex) {
    const schoolSelect = document.getElementById(`child${childIndex}School`);
    const otherSchoolInput = document.getElementById(`child${childIndex}OtherSchool`);
    const gradeDiv = document.getElementById(`child${childIndex}GradeDiv`);
    const gradeSelect = document.getElementById(`child${childIndex}Grade`);
    const carseatDiv = document.getElementById(`child${childIndex}CarseatDiv`);
    const timeTypeDiv = document.getElementById(`child${childIndex}TimeTypeDiv`);
    const timeTypeSelect = document.getElementById(`child${childIndex}TimeType`);
    const ridingTimesDiv = document.getElementById(`child${childIndex}RidingTimes`);

    // Show/hide "Other school" textbox
    otherSchoolInput.style.display = schoolSelect.value === 'other' ? 'block' : 'none';

    if (schoolSelect.value === "") {
        gradeDiv.style.display = 'none';
        carseatDiv.style.display = 'none';
        timeTypeDiv.style.display = 'none';
        ridingTimesDiv.style.display = 'none';
        gradeSelect.innerHTML = "";
        updateCost();
        return;
    }

    // Populate grades depending on school
    let gradeOptions = '<option value="">-- Please select --</option>';
    if (schoolSelect.value === 'OJCS' || schoolSelect.value === 'TDSO') {
        gradeOptions += `
            <option value="preschool">Preschool</option>
            <option value="JK">JK</option>
            <option value="SK">SK</option>
            <option value="Grade 1">Grade 1</option>
            <option value="Grade 2">Grade 2</option>
            <option value="Grade 3">Grade 3</option>
            <option value="Grade 4">Grade 4</option>
            <option value="Grade 5">Grade 5</option>
            <option value="Grade 6">Grade 6</option>
            <option value="Grade 7">Grade 7</option>
            <option value="Grade 8">Grade 8</option>
        `;
    } else if (schoolSelect.value === 'TorahHigh') {
        gradeOptions += `
            <option value="Grade 9">Grade 9</option>
            <option value="Grade 10">Grade 10</option>
            <option value="Grade 11">Grade 11</option>
            <option value="Grade 12">Grade 12</option>
            <option value="adult">Adult</option>
        `;
    } else {
        gradeOptions += `
            <option value="preschool">Preschool</option>
            <option value="JK">JK</option>
            <option value="SK">SK</option>
            <option value="Grade 1">Grade 1</option>
            <option value="Grade 2">Grade 2</option>
            <option value="Grade 3">Grade 3</option>
            <option value="Grade 4">Grade 4</option>
            <option value="Grade 5">Grade 5</option>
            <option value="Grade 6">Grade 6</option>
            <option value="Grade 7">Grade 7</option>
            <option value="Grade 8">Grade 8</option>
            <option value="Grade 9">Grade 9</option>
            <option value="Grade 10">Grade 10</option>
            <option value="Grade 11">Grade 11</option>
            <option value="Grade 12">Grade 12</option>
            <option value="adult">Adult</option>
        `;
    }
    gradeSelect.innerHTML = gradeOptions;
    gradeDiv.style.display = 'block';

    // Reset subsequent fields
    carseatDiv.style.display = 'none';
    timeTypeDiv.style.display = 'none';
    ridingTimesDiv.style.display = 'none';
    gradeSelect.value = "";
    // Don't reset timeTypeSelect.value to preserve selection

    // Add listener for grade change
    gradeSelect.addEventListener('change', () => handleGradeChange(childIndex));
    updateCost();
}

function handleGradeChange(childIndex) {
    const gradeSelect = document.getElementById(`child${childIndex}Grade`);
    const grade = gradeSelect.value;
    const carseatDiv = document.getElementById(`child${childIndex}CarseatDiv`);
    const carseatSelect = document.getElementById(`child${childIndex}Carseat`);
    const timeTypeDiv = document.getElementById(`child${childIndex}TimeTypeDiv`);
    const timeTypeSelect = document.getElementById(`child${childIndex}TimeType`);
    const schoolSelect = document.getElementById(`child${childIndex}School`);
    const ridingTimesDiv = document.getElementById(`child${childIndex}RidingTimes`);

    if (grade === "") {
        carseatDiv.style.display = 'none';
        timeTypeDiv.style.display = 'none';
        ridingTimesDiv.style.display = 'none';
        updateCost();
        return;
    }

    // Show carseat only if grade is preschool, JK, SK, or Grade 1
    if (["preschool", "JK", "SK", "Grade 1"].includes(grade)) {
        carseatDiv.style.display = 'block';
    } else {
        carseatDiv.style.display = 'none';
        carseatSelect.value = "no";
    }

    // Special handling for Torah High
    if (schoolSelect.value === "TorahHigh") {
        // Torah High students are always part time
        timeTypeDiv.style.display = 'none';
        timeTypeSelect.value = 'partTime';
        ridingTimesDiv.style.display = 'block';
        
        // Torah High specific riding restrictions
        const checkboxes = ridingTimesDiv.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb.value.includes('AM') || cb.value === 'Friday PM') {
                cb.disabled = false;
                // Keep existing checked state if possible, otherwise default to checked
                if (!cb.hasAttribute('data-initialized')) {
                    cb.checked = true;
                    cb.setAttribute('data-initialized', 'true');
                }
            } else {
                cb.checked = false;
                cb.disabled = true;
            }
        });
        
        // Add event listeners for checkboxes (only once)
        checkboxes.forEach(cb => {
            if (!cb.hasAttribute('data-listener-added')) {
                cb.addEventListener('change', updateCost);
                cb.setAttribute('data-listener-added', 'true');
            }
        });
    } else {
        // Show full/part time selector for other schools
        timeTypeDiv.style.display = 'block';
        
        // Show riding times if part time is already selected
        if (timeTypeSelect.value === "partTime") {
            ridingTimesDiv.style.display = 'block';
        } else {
            ridingTimesDiv.style.display = 'none';
        }
        
        // Add listener for time type change (only once)
        if (!timeTypeSelect.hasAttribute('data-listener-added')) {
            timeTypeSelect.addEventListener('change', () => {
                if (timeTypeSelect.value === "partTime") {
                    ridingTimesDiv.style.display = 'block';
                    // Enable all checkboxes for non-Torah High schools
                    const checkboxes = ridingTimesDiv.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.disabled = false;
                        if (!cb.hasAttribute('data-listener-added')) {
                            cb.addEventListener('change', updateCost);
                            cb.setAttribute('data-listener-added', 'true');
                        }
                    });
                } else {
                    ridingTimesDiv.style.display = 'none';
                }
                updateCost();
            });
            timeTypeSelect.setAttribute('data-listener-added', 'true');
        }
        
        // If part time is selected, ensure checkboxes are enabled and have listeners
        if (timeTypeSelect.value === "partTime") {
            const checkboxes = ridingTimesDiv.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.disabled = false;
                if (!cb.hasAttribute('data-listener-added')) {
                    cb.addEventListener('change', updateCost);
                    cb.setAttribute('data-listener-added', 'true');
                }
            });
        }
    }

    updateCost();
}

function updateCost() {
    const numChildren = parseInt(document.getElementById('numChildren').value, 10);
    
    // Return early if no children specified
    if (isNaN(numChildren) || numChildren <= 0) {
        document.getElementById('totalCost').innerText = '0';
        document.getElementById('FTEHidden').value = '0';
        document.getElementById('totalCostHidden').value = '0';
        return;
    }

    let a = -100, b = 1300, c = 700, FTE = 0;

    // Calculate FTE for each child
    for (let i = 1; i <= numChildren; i++) {
        const timeTypeElement = document.getElementById(`child${i}TimeType`);
        
        // Check if element exists and has a value
        if (!timeTypeElement || !timeTypeElement.value) {
            continue; // Skip this iteration if element doesn't exist or has no value
        }
        
        const timeType = timeTypeElement.value;
        
        if (timeType === 'fullTime') {
            FTE++;
        } else if (timeType === 'partTime') {
            const ridingTimes = document.querySelectorAll(`#child${i}RidingTimes input[type="checkbox"]:checked:not([disabled])`);
            let fraction = ridingTimes.length / 10;
            FTE += fraction;
        }
    }
    
    let totalCost = a * FTE * FTE + b * FTE + c;
    
    // Apply discount if full payment is selected
    const paymentOptions = document.getElementById('paymentOptions');
    if (paymentOptions && paymentOptions.value === 'fullPayment') {
        totalCost *= 0.98;
    }

    // Update all cost displays
    const finalCost = Math.max(0, totalCost).toFixed(0);
    document.getElementById('FTEHidden').value = FTE.toFixed(1);
    document.getElementById('totalCostHidden').value = finalCost;
    document.getElementById('totalCost').innerText = finalCost;
}
</script>
</body>
</html>
